<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Micromonitor - Home</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #ECE7D5;
      color: #3A5A40;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      background-color: #A3B18A;
      color: white;
      padding: 15px;
      font-size: 24px;
    }
    .login-status {
      text-align: right;
      padding: 10px;
      background: #DAD7CD;
    }
    .login-status a {
      color: #588157;
      text-decoration: none;
      margin: 0 5px;
    }
    .container {
      width: 85%;
      margin: 20px auto 40px auto;
      padding: 20px 24px;
      background: #DAD7CD;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: left;
    }
    .section { margin-bottom: 34px; }
    .section h3 { text-align: center; margin: 0 0 8px 0; }

    input[type="text"], input[type="number"], input[type="datetime-local"], textarea {
      padding: 10px;
      width: 100%;
      max-width: 820px;
      margin: 10px auto;
      border: 1px solid #3A5A40;
      border-radius: 5px;
      background: #FAF3E0;
      box-sizing: border-box;
      display: block;
    }

    .btn-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    button {
      padding: 10px 15px;
      background-color: #588157;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    button:hover:enabled { background-color: #3A5A40; }

    #search-results, #image-scan-results, #my-foods, #recipes-list,
    #parsed-food-output, #plaintext-recipe-output, #chat-answer {
      margin-top: 16px;
      padding: 12px;
      background: white;
      border-radius: 10px;
    }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    .provider-badge { font-weight: bold; color:#344E41; }
    .clickable { cursor:pointer; }
    small.hint { display:block; margin-top:6px; opacity:.8; text-align:center; }

    .inline-preview {
      margin: 8px 0 16px 18px;
      padding: 10px 12px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,.06);
    }

    .nutri-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 6px 14px;
      margin: 8px 0 6px 0;
      padding: 0;
      list-style: none;
    }
    .nutri-pill {
      background: #FAF3E0;
      border: 1px solid #3A5A40;
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 0.95em;
    }

    details summary {
      cursor: pointer;
      user-select: none;
      font-weight: bold;
      margin: 8px 0;
    }

    #recipe-detail {
      display:none;
      margin-top:14px;
      padding:14px;
      background:#fff;
      border-radius:10px;
      box-shadow:0 0 8px rgba(0,0,0,.06);
    }

    .recipe-search-box {
      background:#FAF3E0;
      border:1px solid #3A5A40;
      border-radius:10px;
      padding:12px;
      max-width:820px;
      margin:16px auto 0 auto;
    }

    .recipe-search-inline-input { max-width:260px; }

    /* segmented buttons (used for date range selector) */
    .seg-btn{
      border:1px solid #3F2A1A;
      background:#5C4033;
      color:#FAF3E0;
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
    }
    .seg-btn.seg-on{
      background:#8da88f;
      color:#fff;
      border-color:#6b826d;
    }
    #win-select{flex-wrap:wrap}

    .star {
      font-size: 20px;
      cursor: pointer;
      user-select: none;
      margin-left: 6px;
      color: #C07F00;
    }
  </style>
</head>
<body>
  <header>Micromonitor - Track Your Nutrition</header>

  <div class="login-status" id="login-status">
    <a href="/login">Log In</a> |
    <a href="/register">Register</a> |
    <a href="/my_foods_page">My Saved Foods</a>
  </div>

  <div class="container">

    <!-- Unified Search Section -->
    <div class="section" id="unified-search">
      <h3>Unified Food Search</h3>
      <input type="text" id="search-food" placeholder="Enter food name..." onkeyup="debouncedSearchAll()">
      <div class="btn-row">
        <button id="btn-search" onclick="searchAll()">Search</button>
      </div>

      <div id="search-results"></div>
      <small class="hint">Tip: click a result to preview it right below, then use <b>Save to My Foods</b> when you’re happy.</small>
    </div>

    <!-- Manual Food Input Section with Plaintext Parsing -->
    <div class="section" id="manual-input">
      <h3>Manual Food Input</h3>
      <textarea id="manual-food-plaintext" placeholder="Enter food description in plain text..."></textarea>
      <div class="btn-row">
        <button id="btn-parse" onclick="parseFoodText()">Parse Text to JSON</button>
      </div>
      <div id="parsed-food-output"></div>

      <!-- tiny debug panel for RAG context usage -->
      <div id="parse-debug" class="inline-preview" style="display:none;">
        <strong>Debug context used:</strong>
        <div id="parse-debug-text" style="font-size:0.9em; opacity:0.85;">–</div>
      </div>

      <hr>
      <input type="text" id="manual-food-name" placeholder="Food Name">
      <input type="number" id="manual-calories" placeholder="Calories">
      <input type="number" id="manual-quantity" placeholder="Quantity" value="1">
      <input type="datetime-local" id="manual-created-at" placeholder="Date and Time">
      <small class="hint">
        Choose the exact day and time this food should be saved for (defaults to now; you can pick a different day).
      </small>
      <textarea id="manual-micronutrients" placeholder='Micronutrients as JSON (e.g., [{"name": "Protein", "amount": 10, "unit": "g"}])'></textarea>
      <div class="btn-row">
        <button id="btn-manual-save" onclick="manualInputFood()">Submit Manual Food Input</button>
      </div>
    </div>

    <!-- Image Scanning Section -->
    <div class="section" id="image-scanning">
      <h3>Image Scanning for Food Detection</h3>
      <input type="file" id="food-image">
      <div class="btn-row">
        <button id="btn-image-scan" onclick="scanFoodImage()">Scan Image</button>
      </div>
      <div id="image-scan-results"></div>
    </div>

    <!-- Recipe Generation from Plain Text -->
    <div class="section" id="create-recipe-plaintext">
      <h3>Generate Recipe from Plain Text</h3>
      <textarea id="recipe-plaintext" placeholder="Describe the recipe you want..."></textarea>
      <div class="btn-row">
        <div id="win-select" style="display:flex;gap:8px;align-items:center;margin-right:8px;">
          <button type="button" class="seg-btn seg-on" id="win-today"  data-range="day"   title="Use today's intake">Today</button>
          <button type="button" class="seg-btn" id="win-week"   data-range="week"  title="Use past 7 days">This Week</button>
          <button type="button" class="seg-btn" id="win-month"  data-range="month" title="Use this month">This Month</button>
          <button type="button" class="seg-btn" id="win-custom" data-range="week"  title="Pick a date below">Custom</button>
          <input type="date" id="win-date" style="display:none;" />
        </div>
        <button id="btn-generate-recipe" onclick="createRecipeFromPlaintext()">Generate Recipe</button>
      </div>
      <div id="plaintext-recipe-output"></div>
    </div>

    <!-- Inline Saved Foods Section -->
    <div class="section" id="inline-saved-foods">
      <h3>My Saved Foods (Inline)</h3>
      <div class="btn-row">
        <button id="btn-myfoods" onclick="getMyFoods()">Refresh Saved Foods</button>
      </div>
      <div id="my-foods">No foods loaded yet.</div>
    </div>

    <!-- My Recipes Section -->
    <div class="section" id="my-recipes">
      <h3>My Recipes</h3>
      <div class="btn-row">
        <button id="btn-myrecipes" onclick="getMyRecipes()">Refresh My Recipes</button>
      </div>

      <!-- Recipe search -->
      <div class="recipe-search-box">
        <div class="btn-row" style="margin-top:0;">
          <input
            type="text"
            id="recipe-search-term"
            class="recipe-search-inline-input"
            placeholder="Search by recipe name / text (e.g. chicken)"
            style="width:100%;max-width:260px;"
          >
          <input
            type="text"
            id="recipe-search-nutrient"
            class="recipe-search-inline-input"
            placeholder="Search by micronutrient (e.g. iron)"
            style="width:100%;max-width:260px;"
          >
          <button onclick="searchMyRecipes()">Search</button>
        </div>
        <small class="hint">Leave one blank if you only want to search by the other.</small>
      </div>

      <div id="recipes-list">No recipes loaded yet.</div>
    </div>

    <!-- Nutrition Q&A Chat Section -->
    <div class="section" id="nutrition-chat">
      <h3>Nutrition Q&amp;A</h3>
      <textarea id="chat-question" placeholder="Ask the assistant a nutrition question (e.g., 'How can I increase my iron intake with my saved foods?')"></textarea>
      <div class="btn-row">
        <button id="btn-chat" onclick="askNutrition()">Ask</button>
      </div>
      <div id="chat-answer"></div>
    </div>

  </div>

  <!-- Recipe detail panel -->
  <div id="recipe-detail"
       data-recipe-id=""
       style="display:none; margin-top:14px; padding:14px; background:#fff; border-radius:10px; box-shadow:0 0 8px rgba(0,0,0,.06);">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
      <h4 id="recipe-detail-title" style="margin:0;"></h4>
      <div class="btn-row" style="margin-top:0;">
        <span id="detail-star" class="star" title="Favorite">☆</span>
        <button onclick="deleteRecipe()">Delete</button>
        <button onClick="closeRecipeDetail()">Close</button>
      </div>
    </div>

    <div style="margin:8px 0 12px 0; color:#4b4b; font-size:.95em;" id="recipe-detail-meta"></div>

    <div style="margin:10px 0;">
      <label for="rename-title"><strong>Rename recipe:</strong></label>
      <div class="btn-row" style="justify-content:center;">
        <input type="text" id="rename-title" placeholder="New title.." style="max-width:420px;">
        <button id="btn-rename-recipe" onClick="renameRecipe()">Save Name</button>
      </div>
    </div>

    <hr>

    <div id="recipe-detail-content" style="margin-top:10px;"></div>
  </div>

  <script>
    let debounceTimer;
    let lastPreview = null;
    let favoriteSet = new Set();

    // login status
    fetch('/current_user')
      .then(r => r.json())
      .then(d => {
        if (d.username) {
          document.getElementById("login-status").innerHTML =
            `Logged in as ${d.username} | <a href="/logout">Log Out</a> | <a href="/my_foods_page">My Saved Foods</a>`;
        }
      })
      .catch(() => {});

    function startBusy(btnId, text="Working…") {
      const btn = document.getElementById(btnId);
      if (!btn || btn.disabled) return false;
      btn.dataset.originalText = btn.textContent;
      btn.textContent = text;
      btn.disabled = true;
      btn.style.opacity = "0.7";
      btn.style.cursor = "not-allowed";
      return true;
    }
    function endBusy(btnId) {
      const btn = document.getElementById(btnId);
      if (!btn) return;
      btn.textContent = btn.dataset.originalText || btn.textContent;
      btn.disabled = false;
      btn.style.opacity = "";
      btn.style.cursor = "";
    }

    // default created_at to now for manual input
    (function initManualCreatedAt(){
      const dt = document.getElementById('manual-created-at');
      if (dt && !dt.value) {
        const now = new Date();
        const iso = now.toISOString().slice(0,16); // YYYY-MM-DDTHH:MM
        dt.value = iso;
      }
    })();

    function debouncedSearchAll() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(searchAll, 500);
    }

    function buildResults(container, provider, results) {
      const box = document.createElement("div");
      box.innerHTML = `<h4><span class="provider-badge">${provider.toUpperCase()}</span> results</h4>`;
      const ul = document.createElement("ul");

      results.forEach(item => {
        const fid   = item.food_id || item.fdc_id || item.fdcId || item.id || item.foodId;
        const fname = item.name || item.food_name || item.description || "Unnamed";
        const fbrand= item.brand || item.brand_name || item.brandName || item.brandOwner || "";

        const li = document.createElement("li");
        li.className = "clickable";
        li.textContent = `${fname} ${fbrand ? "(" + fbrand + ")" : ""}`;

        const slot = document.createElement("div");
        slot.className = "inline-preview";
        slot.style.display = "none";

        li.onclick = () => {
          if (slot.style.display === "block") {
            slot.style.display = "none";
            slot.innerHTML = "";
            return;
          }
          Array.from(ul.querySelectorAll(".inline-preview")).forEach(p => {
            p.style.display = "none";
            p.innerHTML = "";
          });
          previewDetail(provider, fid, fname, slot);
        };

        ul.appendChild(li);
        ul.appendChild(slot);
      });

      box.appendChild(ul);
      container.appendChild(box);
    }

    function searchAll() {
      const query = document.getElementById("search-food").value.trim();
      if (!query) {
        alert("Please enter a food name.");
        return;
      }
      const out = document.getElementById("search-results");
      out.innerHTML = "Searching…";

      fetch(`/search_all/${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(data => {
          out.innerHTML = "";

          if (data.fatsecret) {
            let fsResults = [];
            if (Array.isArray(data.fatsecret.results)) {
              fsResults = data.fatsecret.results;
            } else if (data.fatsecret.data && Array.isArray(data.fatsecret.data.results)) {
              fsResults = data.fatsecret.data.results;
            }
            if (fsResults.length) {
              buildResults(out, "fatsecret", fsResults);
            }
          }

          const usda = data.usda;
          if (usda) {
            const results = (usda.data && usda.data.results) || [];
            if (results.length) {
              buildResults(out, "usda", results);

              if (usda.source === "USDA_LOCAL") {
                try {
                  fetch(`/api/usda_enrich?name=${encodeURIComponent(results[0].name || results[0].food_name || "")}`)
                    .catch(()=>{});
                } catch(e) {}
              }
            }
          }

          if (!out.innerText.trim()) {
            out.innerHTML = "<p>No results found.</p>";
          }
        })
        .catch(err => {
          console.error("Error during search:", err);
          out.innerHTML = "Error during search.";
        });
    }

    const SEVEN_MAIN = [
      'Protein',
      'Total lipid (fat)',
      'Carbohydrate, by difference',
      'Sodium, Na',
      'Potassium, K',
      'Calcium, Ca',
      'Iron, Fe'
    ];

    function previewDetail(provider, id, fallbackName, slotEl) {
      fetch(`/api/food_detail?provider=${encodeURIComponent(provider)}&id=${encodeURIComponent(id)}&preview=1`)
        .then(r => r.json())
        .then(d => {
          if (d.error) { alert(d.error); return; }
          const detail = d.detail || {};
          const food = detail.food || {};
          const name = (food.name || fallbackName || "Food").toString();
          const energy = (detail.nutrition && detail.nutrition.calories) ?? "N/A";
          const micros = detail.foodNutrients || detail.micronutrients || [];

          const main = [];
          const others = [];
          const mapName = n => (n.name || "").trim();

          micros.forEach(n => {
            const nm = mapName(n);
            const isMain = SEVEN_MAIN.some(m => m.toLowerCase() === nm.toLowerCase());
            (isMain ? main : others).push(n);
          });

          lastPreview = { provider, id, name, detail, slotEl };

          slotEl.innerHTML = `
            <h4 style="margin:0 0 6px 0">${name}</h4>
            <p style="margin:0 0 8px 0"><strong>Calories:</strong> ${energy}</p>
            ${food.ingredients ? `<p style="margin:0 0 8px 0"><strong>Ingredients:</strong> ${food.ingredients}</p>` : ''}

            <div><strong>Key nutrients (7)</strong></div>
            <ul class="nutri-grid">
              ${main.length ? main.map(n => `<li class="nutri-pill">${n.name}: ${n.amount ?? ''} ${n.unit ?? ''}</li>`).join('') : '<li class="nutri-pill">N/A</li>'}
            </ul>

            <details>
              <summary>Show other nutrients</summary>
              <ul class="nutri-grid">
                ${others.length ? others.map(n => `<li class="nutri-pill">${n.name}: ${n.amount ?? ''} ${n.unit ?? ''}</li>`).join('') : '<li class="nutri-pill">None listed</li>'}
              </ul>
            </details>

            <div style="margin-top:10px;">
              <button id="btn-save-preview">Save to My Foods</button>
            </div>
          `;
          slotEl.style.display = "block";
          const btn = slotEl.querySelector("#btn-save-preview");
          if (btn) btn.onclick = saveLastPreview;
          slotEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        })
        .catch(e => alert("Error loading preview: " + e));
    }

    function saveLastPreview() {
      if (!lastPreview) return;
      const { provider, id, slotEl } = lastPreview;

      fetch(`/api/food_detail?provider=${encodeURIComponent(provider)}&id=${encodeURIComponent(id)}`)
        .then(r => r.json())
        .then(d => {
          if (d.error) { alert(d.error); return; }
          alert(`Saved food id: ${d.saved_food_id}`);
          if (slotEl) { slotEl.style.display = "none"; slotEl.innerHTML = ""; }
          getMyFoods();
        })
        .catch(e => alert("Error saving food: " + e));
    }

    function parseFoodText() {
      const text = document.getElementById("manual-food-plaintext").value;
      if (!text) return alert("Please enter a food description in plain text.");

      const dbg = document.getElementById("parse-debug");
      const dbgText = document.getElementById("parse-debug-text");
      if (dbg) dbg.style.display = "none";
      if (dbgText) dbgText.textContent = "–";

      fetch('/parse_food_text', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ text })
      })
      .then(async r => {
        const data = await r.json();
        if (!r.ok) {
          console.error("parse_food_text error", data);
          if (dbg && dbgText) {
            const docHits = data.doc_rag_hits ?? 0;
            const usdaHits = data.usda_rag_hits ?? 0;
            dbg.style.display = "block";
            dbgText.textContent = `Doc-RAG lines: ${docHits} | USDA AllData lines: ${usdaHits}`;
          }
          alert(data.error || "Error parsing text.");
          return;
        }

        if (data.parsed_food) {
          document.getElementById("parsed-food-output").innerHTML =
            `<pre>${JSON.stringify(data.parsed_food, null, 2)}</pre>`;
          document.getElementById("manual-food-name").value = data.parsed_food.food_name || "";
          document.getElementById("manual-calories").value = data.parsed_food.calories || "";
          document.getElementById("manual-micronutrients").value =
            JSON.stringify(data.parsed_food.micronutrients || [], null, 2);
        }

        if (dbg && dbgText) {
          const docHits = data.doc_rag_hits ?? 0;
          const usdaHits = data.usda_rag_hits ?? 0;
          dbg.style.display = "block";
          dbgText.textContent = `Doc-RAG lines: ${docHits} | USDA AllData lines: ${usdaHits}`;
        }
      })
      .catch(err => {
        console.error("Error parsing food text:", err);
        alert("Error parsing text.");
      });
    }

    function manualInputFood() {
      const foodName = document.getElementById("manual-food-name").value;
      const calories = document.getElementById("manual-calories").value;
      const quantity = document.getElementById("manual-quantity").value;
      const createdAt = document.getElementById("manual-created-at").value;
      const micronutrientsText = document.getElementById("manual-micronutrients").value;
      let micronutrients;
      try { micronutrients = JSON.parse(micronutrientsText || "[]"); }
      catch { return alert("Micronutrients must be valid JSON."); }
      const payload = {
        food_name: foodName,
        calories: parseInt(calories||0),
        quantity: parseFloat(quantity||1),
        micronutrients
      };
      if (createdAt) payload.created_at = createdAt;

      fetch('/manual_input_food', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(d => {
        alert(d.message || d.error || "Done.");
        if (d.message) { getMyFoods(); }
      })
      .catch(err => console.error("Error in manual input:", err));
    }

    // window selector for recipes
    (function(){
      const todayBtn  = document.getElementById('win-today');
      const weekBtn   = document.getElementById('win-week');
      const monthBtn  = document.getElementById('win-month');
      const customBtn = document.getElementById('win-custom');
      const dateInp   = document.getElementById('win-date');

      function ymdToday(){
        const d = new Date();
        return d.toISOString().slice(0,10);
      }

      function select(btn){
        [todayBtn, weekBtn, monthBtn, customBtn].forEach(b=> b && b.classList.remove('seg-on'));
        if(btn) btn.classList.add('seg-on');
        if(btn === customBtn){
          if(dateInp) dateInp.style.display = 'inline-block';
          if(dateInp && !dateInp.value) dateInp.value = ymdToday();
        }else{
          if(dateInp) dateInp.style.display = 'none';
        }
      }

      [todayBtn, weekBtn, monthBtn, customBtn].forEach(b=>{
        if(!b) return;
        b.addEventListener('click', ()=> select(b));
      });

      window._winState = {
        getRangeAndDate: function(){
          const sel = document.querySelector('.seg-btn.seg-on');
          let range = (sel && sel.getAttribute('data-range')) || 'day';
          let date  = (sel === customBtn && dateInp && dateInp.value) ? dateInp.value : ymdToday();
          if(sel === monthBtn) range = 'month';
          if(sel === weekBtn)  range = 'week';
          if(sel === todayBtn) range = 'day';
          return { range, date };
        }
      };
    })();

    function createRecipeFromPlaintext() {
      if (!startBusy("btn-generate-recipe", "Generating…")) return;
      const text = document.getElementById("recipe-plaintext").value;
      if (!text) { alert("Please enter a description for the recipe."); endBusy("btn-generate-recipe"); return; }

      const sel = (window._winState && window._winState.getRangeAndDate)
        ? window._winState.getRangeAndDate()
        : {range:'day', date: new Date().toISOString().slice(0,10)};

      const payload = {
        title: "Generated Recipe",
        ingredients: "",
        micronutrients: [],
        preferences: text,
        generative: true,
        range: sel.range,
        date: sel.date
      };

      fetch('/api/recipes', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      })
      .then(r=>r.json())
      .then(d=>{
        if (d.error) { alert(d.error); return; }
        document.getElementById("plaintext-recipe-output").innerHTML = `<pre>${d.content || ''}</pre>`;
        getMyRecipes();
      })
      .catch(err => console.error("Error generating recipe:", err))
      .finally(() => endBusy("btn-generate-recipe"));
    }

    // favorites helpers
    async function loadFavorites() {
      try {
        const r = await fetch('/api/recipes/favorites');
        if (!r.ok) return;
        const d = await r.json();
        favoriteSet = new Set((d.favorites || []).map(x => String(x.id)));
      } catch (e) {
        favoriteSet = new Set();
      }
    }

    function starHTML(isFav) { return `<span class="star" title="${isFav ? 'Unfavorite' : 'Favorite'}">${isFav ? '★' : '☆'}</span>`; }

    async function toggleFavorite(recipeId, el) {
      const idStr = String(recipeId);
      const isFav = favoriteSet.has(idStr);
      try {
        if (isFav) {
          const r = await fetch(`/api/recipes/${encodeURIComponent(recipeId)}/favorite`, { method: 'DELETE' });
          if (r.ok) favoriteSet.delete(idStr);
        } else {
          const r = await fetch(`/api/recipes/${encodeURIComponent(recipeId)}/favorite`, { method: 'POST' });
          const d = await r.json();
          if (r.ok && d.ok) favoriteSet.add(idStr);
        }
      } catch (e) {}
      if (el) el.innerHTML = isFav ? '☆' : '★';
      syncDetailStar();
    }

    function syncDetailStar() {
      const panel = document.getElementById("recipe-detail");
      const id = panel.dataset.recipeId;
      const star = document.getElementById("detail-star");
      if (!id || !star) return;
      const on = favoriteSet.has(String(id));
      star.textContent = on ? '★' : '☆';
      star.title = on ? 'Unfavorite' : 'Favorite';
    }

    async function getMyRecipes() {
      await loadFavorites();
      fetch('/api/recipes/mine')
        .then(r=>r.json())
        .then(data=>{
          const div = document.getElementById("recipes-list");
          div.innerHTML = "";
          const arr = data.recipes || [];
          if (!arr.length) { div.textContent = "No recipes yet."; return; }

          arr.forEach(rcp=>{
            const id = String(rcp.id || rcp.recipe_id);
            const row = document.createElement("div");
            row.style.padding = "6px 0";
            row.style.borderBottom = "1px solid #e6e6e6";

            const isFav = favoriteSet.has(id);
            row.innerHTML = `
              <div class="clickable" style="text-align:left;display:flex;align-items:center;gap:8px;">
                <strong>${rcp.title}</strong> — ${rcp.created_at || ''}
                <span class="star" data-id="${id}" title="${isFav ? 'Unfavorite' : 'Favorite'}">${isFav ? '★' : '☆'}</span>
              </div>
            `;
            row.querySelector('strong').onclick = () => openRecipe(id);
            const starEl = row.querySelector('.star');
            starEl.onclick = (e) => { e.stopPropagation(); toggleFavorite(id, starEl); };

            div.appendChild(row);
          });
        })
        .catch(err=>console.error("Error loading recipes:", err));
    }

    function searchMyRecipes() {
      const termEl = document.getElementById("recipe-search-term");
      const nutEl  = document.getElementById("recipe-search-nutrient");

      const termVal = termEl ? termEl.value.trim() : "";
      const nutVal  = nutEl ? nutEl.value.trim() : "";

      const params = new URLSearchParams();
      if (termVal) params.append("term", termVal);
      if (nutVal)  params.append("nutrient", nutVal);

      const div = document.getElementById("recipes-list");
      div.textContent = "Searching...";

      fetch("/api/recipes/search?" + params.toString())
        .then(r => r.json())
        .then(async data => {
          await loadFavorites();
          div.innerHTML = "";
          if (data.error) {
            div.textContent = "Error: " + data.error;
            return;
          }
          const arr = data.recipes || [];
          if (!arr.length) {
            div.textContent = "No matching recipes.";
            return;
          }
          arr.forEach(rcp => {
            const id = String(rcp.id || rcp.recipe_id);
            const isFav = favoriteSet.has(id);
            const row = document.createElement("div");
            row.style.padding = "6px 0";
            row.style.borderBottom = "1px solid #e6e6e6";
            row.innerHTML = `
              <div class="clickable" style="text-align:left;display:flex;align-items:center;gap:8px;">
                <strong>${rcp.title}</strong> — ${rcp.created_at || ''}
                <span class="star" data-id="${id}" title="${isFav ? 'Unfavorite' : 'Favorite'}">${isFav ? '★' : '☆'}</span>
              </div>`;
            row.querySelector('strong').onclick = () => openRecipe(id);
            const starEl = row.querySelector('.star');
            starEl.onclick = (e) => { e.stopPropagation(); toggleFavorite(id, starEl); };
            div.appendChild(row);
          });
        })
        .catch(err => {
          console.error("searchMyRecipes error", err);
          div.textContent = "Search failed.";
        });
    }

    function renderRecipeDetail(recipe) {
      const panel = document.getElementById("recipe-detail");
      const titleEl = document.getElementById("recipe-detail-title");
      const metaEl  = document.getElementById("recipe-detail-meta");
      const bodyEl  = document.getElementById("recipe-detail-content");
      const renameInput = document.getElementById("rename-title");

      panel.dataset.recipeId = recipe.id || recipe.recipe_id || "";

      titleEl.textContent = recipe.title || "Untitled recipe";
      metaEl.textContent  = recipe.created_at ? `Created — ${recipe.created_at}` : "";

      if (renameInput) {
        renameInput.value = recipe.title || "";
      }

      if (recipe.content_html) {
        bodyEl.innerHTML = recipe.content_html;
      } else if (recipe.content) {
        bodyEl.innerHTML = `<pre>${typeof recipe.content === "string"
          ? recipe.content
          : JSON.stringify(recipe.content, null, 2)
        }</pre>`;
      } else {
        const ing  = recipe.ingredients ? `<h5>Ingredients</h5><pre>${recipe.ingredients}</pre>` : "";
        const instr= recipe.instructions ? `<h5>Instructions</h5><pre>${recipe.instructions}</pre>` : "";
        const micro= recipe.micronutrients ? `<h5>Micronutrients</h5><pre>${JSON.stringify(recipe.micronutrients,null,2)}</pre>` : "";
        bodyEl.innerHTML = ing + instr + micro || "<em>No recipe body returned.</em>";
      }

      panel.style.display = "block";
      panel.scrollIntoView({behavior:"smooth", block:"start"});
      syncDetailStar();
    }

    async function openRecipe(idOrObj) {
      if (typeof idOrObj === "object" && idOrObj) {
        renderRecipeDetail(idOrObj);
        return;
      }
      const id = idOrObj;
      try {
        const r1 = await fetch(`/api/recipes/${encodeURIComponent(id)}`);
        if (r1.ok) {
          const d = await r1.json();
          const recipe = d.recipe || d || {};
          recipe.id = recipe.id || id;
          renderRecipeDetail(recipe);
          const pnl = document.getElementById('recipe-detail');
          if (pnl) pnl.dataset.recipeId = String(recipe.id || recipe.recipe_id || id || "");
          syncDetailStar();
          return;
        }
        if (r1.status === 405) throw new Error("405");
      } catch (e) {
        try {
          const r2 = await fetch('/api/recipes/mine');
          if (r2.ok) {
            const d2 = await r2.json();
            const arr = d2.recipes || [];
            const found = arr.find(x => String(x.id || x.recipe_id) === String(id));
            if (found) { renderRecipeDetail(found); return; }
          }
        } catch (e2) {}
        alert("Could not open that recipe.");
      }
    }

    async function renameRecipe() {
      const panel = document.getElementById("recipe-detail");
      const id    = panel.dataset.recipeId;
      const newTitle = (document.getElementById("rename-title") || {}).value?.trim();
      if (!id) return alert("No recipe selected.");
      if (!newTitle) return alert("Enter a new name first.");

      let ok = false;
      try {
        const r = await fetch(`/api/recipes/${encodeURIComponent(id)}/rename`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ title: newTitle })
        });
        ok = r.ok;
      } catch (e) {}

      if (!ok) {
        try {
          const r = await fetch(`/api/recipes/${encodeURIComponent(id)}`, {
            method: 'PATCH',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ title: newTitle })
          });
          ok = r.ok;
        } catch (e) {}
      }

      if (ok) {
        document.getElementById("recipe-detail-title").textContent = newTitle;
        const rti = document.getElementById("rename-title");
        if (rti) rti.value = "";
        getMyRecipes();
      } else {
        alert("Rename failed.");
      }
    }

    function deleteRecipe() {
      const panel = document.getElementById("recipe-detail");
      const rid = panel.dataset.recipeId;
      if (!rid) {
        alert("No recipe selected.");
        return;
      }
      if (!confirm("Really delete this recipe? This can't be undone.")) {
        return;
      }

      fetch(`/api/recipes/${encodeURIComponent(rid)}`, { method: "DELETE" })
      .then(r => r.json())
      .then(d => {
        if (d.ok) {
          closeRecipeDetail();
          getMyRecipes();
        } else {
          alert(d.error || "Delete failed.");
        }
      })
      .catch(err => {
        console.error("Error deleting recipe:", err);
        alert("Error deleting recipe.");
      });
    }

    function closeRecipeDetail() {
      const panel = document.getElementById("recipe-detail");
      panel.style.display = "none";
      panel.dataset.recipeId = "";
      document.getElementById("recipe-detail-content").innerHTML = "";
      document.getElementById("recipe-detail-meta").textContent = "";
      const rti = document.getElementById("rename-title");
      if (rti) rti.value = "";
    }

    function getMyFoods() {
      fetch('/my_foods')
      .then(r => r.json())
      .then(data => {
        const div = document.getElementById("my-foods");
        div.innerHTML = "";
        const foods = data.foods || [];
        if (foods.length) {
          const ul = document.createElement("ul");
          foods.forEach(food => {
            const li = document.createElement("li");
            li.className = "clickable";
            li.innerText = `${food.food_name} - ${food.calories ?? '0'} kcal, Qty: ${food.quantity ?? 1} (Saved: ${food.created_at || "N/A"})`;
            ul.appendChild(li);
          });
          div.appendChild(ul);
        } else {
          div.innerText = "No saved foods found.";
        }
      })
      .catch(err => console.error("Error fetching saved foods:", err));
    }

    function scanFoodImage() {
      const input = document.getElementById("food-image");
      const file = input.files[0];
      if (!file) {
        alert("Please choose an image file first.");
        return;
      }
      if (!startBusy("btn-image-scan", "Scanning…")) return;

      const formData = new FormData();
      formData.append("file", file);

      fetch("/scan_food_image", {
        method: "POST",
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        const div = document.getElementById("image-scan-results");
        if (data.error) {
          div.textContent = "Error: " + data.error;
          return;
        }
        div.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      })
      .catch(err => {
        console.error("scanFoodImage error", err);
        alert("Image scan failed.");
      })
      .finally(() => endBusy("btn-image-scan"));
    }

    // Nutrition Q&A chat using /ask
    function askNutrition() {
      const q = document.getElementById('chat-question').value.trim();
      const out = document.getElementById('chat-answer');
      if (!q) {
        alert("Please enter a question.");
        return;
      }
      if (!startBusy("btn-chat", "Thinking…")) return;
      out.innerHTML = "Asking…";

      fetch('/ask', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ question: q })
      })
      .then(r => r.json())
      .then(d => {
        if (d.error) {
          out.textContent = d.error;
          return;
        }
        const ans = d.answer || "(no answer returned)";
        out.innerHTML = `<strong>Answer:</strong><br><pre>${ans}</pre>`;
      })
      .catch(err => {
        console.error("askNutrition error", err);
        out.textContent = "Error asking the model.";
      })
      .finally(() => endBusy("btn-chat"));
    }

    getMyFoods();
    getMyRecipes();

    document.getElementById('detail-star').onclick = function(){
      const panel = document.getElementById('recipe-detail');
      const id = panel.dataset.recipeId;
      if (!id) return;
      toggleFavorite(id, this);
    };
  </script>
</body>
</html>
