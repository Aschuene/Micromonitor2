<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Micromonitor - Home</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #ECE7D5;
      color: #3A5A40;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      background-color: #A3B18A;
      color: white;
      padding: 15px;
      font-size: 24px;
    }
    .login-status {
      text-align: right;
      padding: 10px;
      background: #DAD7CD;
    }
    .login-status a {
      color: #588157;
      text-decoration: none;
      margin: 0 5px;
    }
    .container {
      width: 85%;
      margin: 20px auto 40px auto;
      padding: 20px 24px;
      background: #DAD7CD;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: left;
    }
    .section { margin-bottom: 34px; }
    .section h3 { text-align: center; margin: 0 0 8px 0; }

    input[type="text"], input[type="number"], input[type="datetime-local"], textarea {
      padding: 10px;
      width: 100%;
      max-width: 820px;
      margin: 10px auto;
      border: 1px solid #3A5A40;
      border-radius: 5px;
      background: #FAF3E0;
      box-sizing: border-box;
      display: block;
    }

    /* Centered button rows */
    .btn-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    button {
      padding: 10px 15px;
      background-color: #588157;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    button:hover:enabled { background-color: #3A5A40; }

    /* Content boxes */
    #search-results, #image-scan-results, #my-foods, #recipes-list,
    #parsed-food-output, #plaintext-recipe-output {
      margin-top: 16px;
      padding: 12px;
      background: white;
      border-radius: 10px;
    }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    .provider-badge { font-weight: bold; color:#344E41; }
    .clickable { cursor:pointer; }
    small.hint { display:block; margin-top:6px; opacity:.8; text-align:center; }

    /* Inline preview under a clicked result */
    .inline-preview {
      margin: 8px 0 16px 18px;
      padding: 10px 12px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,.06);
    }

    .nutri-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 6px 14px;
      margin: 8px 0 6px 0;
      padding: 0;
      list-style: none;
    }
    .nutri-pill {
      background: #FAF3E0;
      border: 1px solid #3A5A40;
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 0.95em;
    }

    details summary {
      cursor: pointer;
      user-select: none;
      font-weight: bold;
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <header>Micromonitor - Track Your Nutrition</header>

  <div class="login-status" id="login-status">
    <a href="/login">Log In</a> |
    <a href="/register">Register</a> |
    <a href="/my_foods_page">My Saved Foods</a>
  </div>

  <div class="container">
    <!-- Unified Search Section -->
    <div class="section" id="unified-search">
      <h3>Unified Food Search</h3>
      <input type="text" id="search-food" placeholder="Enter food name..." onkeyup="debouncedSearchAll()">
      <div class="btn-row">
        <button id="btn-search" onclick="searchAll()">Search</button>
      </div>

      <div id="search-results"></div>
      <small class="hint">Tip: click a result to preview it right below, then use <b>Save to My Foods</b> when you’re happy.</small>
    </div>

    <!-- Manual Food Input Section with Plaintext Parsing -->
    <div class="section" id="manual-input">
      <h3>Manual Food Input</h3>
      <textarea id="manual-food-plaintext" placeholder="Enter food description in plain text..."></textarea>
      <div class="btn-row">
        <button id="btn-parse" onclick="parseFoodText()">Parse Text to JSON</button>
      </div>
      <div id="parsed-food-output"></div>
      <hr>
      <input type="text" id="manual-food-name" placeholder="Food Name">
      <input type="number" id="manual-calories" placeholder="Calories">
      <input type="number" id="manual-quantity" placeholder="Quantity" value="1">
      <input type="datetime-local" id="manual-created-at" placeholder="Date and Time">
      <textarea id="manual-micronutrients" placeholder='Micronutrients as JSON (e.g., [{"name": "Protein", "amount": 10, "unit": "g"}])'></textarea>
      <div class="btn-row">
        <button id="btn-manual-save" onclick="manualInputFood()">Submit Manual Food Input</button>
      </div>
    </div>

    <!-- Image Scanning Section -->
    <div class="section" id="image-scanning">
      <h3>Image Scanning for Food Detection</h3>
      <input type="file" id="food-image">
      <div class="btn-row">
        <button id="btn-image-scan" onclick="scanFoodImage()">Scan Image</button>
      </div>
      <div id="image-scan-results"></div>
    </div>

    <!-- Recipe Generation from Plain Text -->
    <div class="section" id="create-recipe-plaintext">
      <h3>Generate Recipe from Plain Text</h3>
      <textarea id="recipe-plaintext" placeholder="Describe the recipe you want..."></textarea>
      <div class="btn-row">
        <button id="btn-generate-recipe" onclick="createRecipeFromPlaintext()">Generate Recipe</button>
      </div>
      <div id="plaintext-recipe-output"></div>
    </div>

    <!-- Inline Saved Foods Section -->
    <div class="section" id="inline-saved-foods">
      <h3>My Saved Foods (Inline)</h3>
      <div class="btn-row">
        <button id="btn-myfoods" onclick="getMyFoods()">Refresh Saved Foods</button>
      </div>
      <div id="my-foods">No foods loaded yet.</div>
    </div>

    <!-- My Recipes Section -->
    <div class="section" id="my-recipes">
      <h3>My Recipes</h3>
      <div class="btn-row">
        <button id="btn-myrecipes" onclick="getMyRecipes()">Refresh My Recipes</button>
      </div>
      <div id="recipes-list">No recipes loaded yet.</div>
    </div>
  </div>

  <!-- — Recipe detail panel (appears when a recipe is clicked) — -->
  <div id="recipe-detail" style="display:none; margin-top:14px; padding:14px; background:#fff; border-radius:10px; box-shadow:0 0 8px rgba(0,0,0,.06);">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
      <h4 id="recipe-detail-title" style="margin:0;"></h4>
      <button onClick="closeRecipeDetail()">Close</button>
    </div>

    <div style="margin:8px 0 12px 0; color:#4b4b; font-size:.95em;" id="recipe-detail-meta"></div>

    <div style="margin:10px 0;">
      <label for="rename-title"><strong>Rename recipe:</strong></label>
      <div class="btn-row" style="justify-content:flex-start;">
        <input type="text" id="rename-title" placeholder="New title.." style="max-width:420px;">
        <button id="btn-rename-recipe" onClick="renameRecipe()">Save Name</button>
      </div>
    </div>

    <hr>

    <div id="recipe-detail-content" style="margin-top:10px;"></div>
  </div>
</div>

  <script>
    let debounceTimer;

    // Update navigation based on current user
    fetch('/current_user')
      .then(r => r.json())
      .then(d => {
        if (d.username) {
          document.getElementById("login-status").innerHTML =
            `Logged in as ${d.username} | <a href="/logout">Log Out</a> | <a href="/my_foods_page">My Saved Foods</a>`;
        }
      })
      .catch(() => {});

    // --- Busy-state helpers ---
    function startBusy(btnId, text="Working…") {
      const btn = document.getElementById(btnId);
      if (!btn || btn.disabled) return false;
      btn.dataset.originalText = btn.textContent;
      btn.textContent = text;
      btn.disabled = true;
      btn.style.opacity = "0.7";
      btn.style.cursor = "not-allowed";
      return true;
    }
    function endBusy(btnId) {
      const btn = document.getElementById(btnId);
      if (!btn) return;
      btn.textContent = btn.dataset.originalText || btn.textContent;
      btn.disabled = false;
      btn.style.opacity = "";
      btn.style.cursor = "";
    }

    // --- Debounced search ---
    function debouncedSearchAll() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(searchAll, 500);
    }

    // Helper to build a result list (provider: "fatsecret" | "usda")
    function buildResults(container, provider, results) {
      const box = document.createElement("div");
      box.innerHTML = `<h4><span class="provider-badge">${provider.toUpperCase()}</span> results</h4>`;
      const ul = document.createElement("ul");

      results.forEach(item => {
        const li = document.createElement("li");
        li.className = "clickable";
        li.textContent = `${item.name} ${item.brand ? `(${item.brand})` : ""}`;

        // Inline preview slot directly under this item
        const slot = document.createElement("div");
        slot.className = "inline-preview";
        slot.style.display = "none";

        li.onclick = () => {
          // toggle if already open
          if (slot.style.display === "block") {
            slot.style.display = "none"; slot.innerHTML = "";
            return;
          }
          // close others in this UL
          Array.from(ul.querySelectorAll(".inline-preview")).forEach(p => {
            p.style.display = "none"; p.innerHTML = "";
          });
          previewDetail(provider, item.food_id, item.name, slot);
        };

        ul.appendChild(li);
        ul.appendChild(slot);
      });

      box.appendChild(ul);
      container.appendChild(box);
    }

    function searchAll() {
      const query = document.getElementById("search-food").value.trim();
      if (!query) { alert("Please enter a food name."); return; }
      const out = document.getElementById("search-results");
      out.innerHTML = "Searching…";

      fetch(`/search_all/${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(data => {
          out.innerHTML = "";

          // FatSecret
          if (data.fatsecret) {
            if (data.fatsecret.error) {
              const e = document.createElement("p");
              e.textContent = `FatSecret error: ${data.fatsecret.error}`;
              out.appendChild(e);
            } else {
              const results = (data.fatsecret.data && data.fatsecret.data.results) || [];
              if (results.length) buildResults(out, "fatsecret", results);
            }
          }

          // USDA API (show). USDA_LOCAL (CSV) -> do not render, can enrich silently
          const usda = data.usda;
          if (usda && usda.source === "USDA_API") {
            const results = (usda.data && usda.data.results) || [];
            if (results.length) buildResults(out, "usda", results);
          } else if (usda && usda.source === "USDA_LOCAL") {
            try {
              const results = (usda.data && usda.data.results) || [];
              if (results.length) {
                fetch(`/api/usda_enrich?name=${encodeURIComponent(results[0].name)}`).catch(()=>{});
              }
            } catch(e) {}
          }

          if (!out.innerText.trim()) out.innerHTML = "<p>No results found.</p>";
        })
        .catch(err => {
          console.error("Error during search:", err);
          out.innerHTML = "Error during search.";
        });
    }

    // --- Preview then Save ---
    const SEVEN_MAIN = [
      'Protein',
      'Total lipid (fat)',
      'Carbohydrate, by difference',
      'Sodium, Na',
      'Potassium, K',
      'Calcium, Ca',
      'Iron, Fe'
    ];

    let lastPreview = null; // {provider, id, name, detail, slotEl}

    function previewDetail(provider, id, fallbackName, slotEl) {
      fetch(`/api/food_detail?provider=${encodeURIComponent(provider)}&id=${encodeURIComponent(id)}&preview=1`)
        .then(r => r.json())
        .then(d => {
          if (d.error) { alert(d.error); return; }
          const detail = d.detail || {};
          const food = detail.food || {};
          const name = (food.name || fallbackName || "Food").toString();
          const energy = (detail.nutrition && detail.nutrition.calories) ?? "N/A";
          const micros = detail.foodNutrients || detail.micronutrients || [];

          // Split nutrients into 7-main and others (case-insensitive match)
          const main = [];
          const others = [];
          const mapName = n => (n.name || "").trim();

          micros.forEach(n => {
            const nm = mapName(n);
            const isMain = SEVEN_MAIN.some(m => m.toLowerCase() === nm.toLowerCase());
            (isMain ? main : others).push(n);
          });

          lastPreview = { provider, id, name, detail, slotEl };

          slotEl.innerHTML = `
            <h4 style="margin:0 0 6px 0">${name}</h4>
            <p style="margin:0 0 8px 0"><strong>Calories:</strong> ${energy}</p>
            ${food.ingredients ? `<p style="margin:0 0 8px 0"><strong>Ingredients:</strong> ${food.ingredients}</p>` : ''}

            <div><strong>Key nutrients (7)</strong></div>
            <ul class="nutri-grid">
              ${main.length ? main.map(n => `<li class="nutri-pill">${n.name}: ${n.amount ?? ''} ${n.unit ?? ''}</li>`).join('') : '<li class="nutri-pill">N/A</li>'}
            </ul>

            <details>
              <summary>Show other nutrients</summary>
              <ul class="nutri-grid">
                ${others.length ? others.map(n => `<li class="nutri-pill">${n.name}: ${n.amount ?? ''} ${n.unit ?? ''}</li>`).join('') : '<li class="nutri-pill">None listed</li>'}
              </ul>
            </details>

            <div style="margin-top:10px;">
              <button id="btn-save-preview">Save to My Foods</button>
            </div>
          `;
          slotEl.style.display = "block";
          const btn = slotEl.querySelector("#btn-save-preview");
          if (btn) btn.onclick = saveLastPreview;
          slotEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        })
        .catch(e => alert("Error loading preview: " + e));
    }

    function saveLastPreview() {
      if (!lastPreview) return;
      const { provider, id, slotEl } = lastPreview;

      fetch(`/api/food_detail?provider=${encodeURIComponent(provider)}&id=${encodeURIComponent(id)}`)
        .then(r => r.json())
        .then(d => {
          if (d.error) { alert(d.error); return; }
          alert(`Saved food id: ${d.saved_food_id}`);
          if (slotEl) { slotEl.style.display = "none"; slotEl.innerHTML = ""; }
          getMyFoods();
        })
        .catch(e => alert("Error saving food: " + e));
    }

    // --- Manual Food Input: parse + submit ---
    function parseFoodText() {
      const text = document.getElementById("manual-food-plaintext").value;
      if (!text) return alert("Please enter a food description in plain text.");
      fetch('/parse_food_text', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text})
      })
      .then(r => r.json())
      .then(data => {
        if (data.parsed_food) {
          document.getElementById("parsed-food-output").innerHTML =
            `<pre>${JSON.stringify(data.parsed_food, null, 2)}</pre>`;
          document.getElementById("manual-food-name").value = data.parsed_food.food_name || "";
          document.getElementById("manual-calories").value = data.parsed_food.calories || "";
          document.getElementById("manual-micronutrients").value =
            JSON.stringify(data.parsed_food.micronutrients || [], null, 2);
        } else {
          alert(data.error || "Error parsing text.");
        }
      })
      .catch(err => console.error("Error parsing food text:", err));
    }

    function manualInputFood() {
      const foodName = document.getElementById("manual-food-name").value;
      const calories = document.getElementById("manual-calories").value;
      const quantity = document.getElementById("manual-quantity").value;
      const createdAt = document.getElementById("manual-created-at").value;
      const micronutrientsText = document.getElementById("manual-micronutrients").value;
      let micronutrients;
      try { micronutrients = JSON.parse(micronutrientsText || "[]"); }
      catch { return alert("Micronutrients must be valid JSON."); }
      const payload = {
        food_name: foodName,
        calories: parseInt(calories||0),
        quantity: parseFloat(quantity||1),
        micronutrients
      };
      if (createdAt) payload.created_at = createdAt;

      fetch('/manual_input_food', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(d => {
        alert(d.message || d.error || "Done.");
        if (d.message) { getMyFoods(); }
      })
      .catch(err => console.error("Error in manual input:", err));
    }

    // --- Recipes: create + list (rename handled server-side endpoints) ---
    function createRecipeFromPlaintext() {
      if (!startBusy("btn-generate-recipe", "Generating…")) return;
      const text = document.getElementById("recipe-plaintext").value;
      if (!text) { alert("Please enter a description for the recipe."); endBusy("btn-generate-recipe"); return; }
      const payload = { title: "Generated Recipe", ingredients: "", micronutrients: [], preferences: text, generative: true };
      fetch('/api/recipes', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      })
      .then(r=>r.json())
      .then(d=>{
        if (d.error) { alert(d.error); return; }
        document.getElementById("plaintext-recipe-output").innerHTML = `<pre>${d.content || ''}</pre>`;
        getMyRecipes();
      })
      .catch(err => console.error("Error generating recipe:", err))
      .finally(() => endBusy("btn-generate-recipe"));
    }

    function getMyRecipes() {
      fetch('/api/recipes/mine')
        .then(r=>r.json())
        .then(data=>{
          const div = document.getElementById("recipes-list");
          div.innerHTML = "";
          const arr = data.recipes || [];
          if (!arr.length) { div.textContent = "No recipes yet."; return; }

          arr.forEach(rcp=>{
            const row = document.createElement("div");
            row.style.padding = "6px 0";
            row.style.borderBottom = "1px solid #e6e6e6";
            row.innerHTML = `<div class="clickable" style="text-align:left;"><strong>${rcp.title}</strong> — ${rcp.created_at || ''}</div>`;
            row.onclick = () => openRecipe(rcp.id || rcp.recipe_id || rcp);
            div.appendChild(row);
          });
        })
        .catch(err=>console.error("Error loading recipes:", err));
    }

    // --- Image scan (placeholder-friendly) ---
    
    // ========== Recipe detail helpers & actions ==========
    function renderRecipeDetail(recipe) {
      const panel = document.getElementById("recipe-detail");
      const titleEl = document.getElementById("recipe-detail-title");
      const metaEl  = document.getElementById("recipe-detail-meta");
      const bodyEl  = document.getElementById("recipe-detail-content");

      panel.dataset.recipeId = recipe.id || recipe.recipe_id;

      titleEl.textContent = recipe.title || "Untitled recipe";
      metaEl.textContent  = recipe.created_at ? `Created — ${recipe.created_at}` : "";

      if (recipe.content_html) {
        bodyEl.innerHTML = recipe.content_html;
      } else if (recipe.content) {
        bodyEl.innerHTML = `<pre>${typeof recipe.content === "string" ? recipe.content : JSON.stringify(recipe.content, null, 2)}</pre>`;
      } else {
        const ing  = recipe.ingredients ? `<h5>Ingredients</h5><pre>${recipe.ingredients}</pre>` : "";
        const instr= recipe.instructions ? `<h5>Instructions</h5><pre>${recipe.instructions}</pre>` : "";
        const micro= recipe.micronutrients ? `<h5>Micronutrients</h5><pre>${JSON.stringify(recipe.micronutrients,null,2)}</pre>` : "";
        bodyEl.innerHTML = ing + instr + micro || "<em>No recipe body returned.</em>";
      }

      panel.style.display = "block";
      panel.scrollIntoView({behavior:"smooth", block:"start"});
    }

    function closeRecipeDetail() {
      const panel = document.getElementById("recipe-detail");
      panel.style.display = "none";
      panel.removeAttribute("data-recipe-id");
      document.getElementById("recipe-detail-content").innerHTML = "";
      document.getElementById("recipe-detail-meta").textContent = "";
      const rti = document.getElementById("rename-title");
      if (rti) rti.value = "";
    }

    async function openRecipe(idOrObj) {
      if (typeof idOrObj === "object" && idOrObj) {
        renderRecipeDetail(idOrObj);
        return;
      }
      const id = idOrObj;
      try {
        const r1 = await fetch(`/api/recipes/${encodeURIComponent(id)}`);
        if (r1.ok) {
          const d = await r1.json();
          const recipe = d.recipe || d || {};
          recipe.id = recipe.id || id;
          renderRecipeDetail(recipe);
          return;
        }
        if (r1.status === 405) throw new Error("405");
      } catch (e) {
        try {
          const r2 = await fetch('/api/recipes/mine');
          if (r2.ok) {
            const d2 = await r2.json();
            const arr = d2.recipes || [];
            const found = arr.find(x => String(x.id || x.recipe_id) === String(id));
            if (found) { renderRecipeDetail(found); return; }
          }
        } catch (e2) {}
        alert("Could not open that recipe (endpoint returned 405 and fallback failed).");
      }
    }

    async function renameRecipe() {
      const panel = document.getElementById("recipe-detail");
      const id    = panel.dataset.recipeId;
      const newTitle = (document.getElementById("rename-title") || {}).value?.trim();
      if (!id) return alert("No recipe selected.");
      if (!newTitle) return alert("Enter a new name first.");

      let ok = false, msg = "";
      try {
        const r = await fetch(`/api/recipes/${encodeURIComponent(id)}/rename`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ title: newTitle })
        });
        ok = r.ok;
        msg = (await r.json()).message || "";
      } catch (e) {}

      if (!ok) {
        try {
          const r = await fetch(`/api/recipes/${encodeURIComponent(id)}`, {
            method: 'PATCH',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ title: newTitle })
          });
          ok = r.ok;
          msg = (await r.json()).message || "";
        } catch (e) {}
      }

      if (ok) {
        document.getElementById("recipe-detail-title").textContent = newTitle;
        const rti = document.getElementById("rename-title");
        if (rti) rti.value = "";
        getMyRecipes();
      } else {
        alert(msg || "Rename failed (no matching endpoint).");
      }
    }
function scanFoodImage() {
      const file = document.getElementById("food-image").files[0];
      if (!file) return alert("Please select an image file.");
      if (!startBusy("btn-image-scan", "Scanning…")) return;

      const formData = new FormData();
      formData.append("file", file);
      fetch('/scan_food_image', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
          const resultsDiv = document.getElementById("image-scan-results");
          resultsDiv.style.display = "block";
          resultsDiv.innerHTML = "";
          if (data.detected_foods) {
            data.detected_foods.forEach(food => {
              const div = document.createElement("div");
              div.innerHTML = `<strong>${food.food_name}</strong> - Confidence: ${(food.confidence * 100).toFixed(0)}%<br>
                               Bounding Box: [${food.bounding_box}]`;
              resultsDiv.appendChild(div);
            });
          } else {
            resultsDiv.innerText = "No food detected.";
          }
          if (data.llm_response) {
            const llamaDiv = document.createElement("div");
            llamaDiv.innerHTML = `<strong>Model Response:</strong><br>${data.llm_response}`;
            resultsDiv.appendChild(llamaDiv);
          }
        })
        .catch(err => {
          console.error("Error scanning image:", err);
          alert("Error scanning image.");
        })
        .finally(() => endBusy("btn-image-scan"));
    }

    // --- Saved foods helper (kept for inline section) ---
    function getMyFoods() {
      fetch('/my_foods')
      .then(r => r.json())
      .then(data => {
        const div = document.getElementById("my-foods");
        div.innerHTML = "";
        const foods = data.foods || [];
        if (foods.length) {
          const ul = document.createElement("ul");
          foods.forEach(food => {
            const li = document.createElement("li");
            li.className = "clickable";
            li.innerText = `${food.food_name} - ${food.calories ?? '0'} kcal, Qty: ${food.quantity ?? 1} (Saved: ${food.created_at || "N/A"})`;
            ul.appendChild(li);
          });
          div.appendChild(ul);
        } else {
          div.innerText = "No saved foods found.";
        }
      })
      .catch(err => console.error("Error fetching saved foods:", err));
    }
  </script>
</body>
</html>
